FROM node:10.16

WORKDIR /usr/src/app

COPY package*.json ./
RUN npm install

COPY . .

ARG SENDGRID_API_KEY
    
ARG AWS_S3_BUCKET_NAME
ARG AWS_S3_IMAGE_FOLDER
ARG AWS_ACCESS_KEY_S3
ARG AWS_SECRET_ACCESS_KEY_S3

ARG PAYPAL_LOW_BALANCE_THRESHOLD
ARG PAYPAL_MODE
ARG PAYPAL_CLIENT_ID
ARG PAYPAL_CLIENT_SECRET
ARG PAYPAL_NVP_API_USERNAME
ARG PAYPAL_NVP_API_PASSWORD
ARG PAYPAL_NVP_API_SIGNATURE

ARG TRANSFERWISE_API
ARG TRANSFERWISE_API_KEY
ARG TRANSFERWISE_LOW_BALANCE_THRESHOLD

ARG DATABASE_HOST
ARG DATABASE_PORT
ARG DATABASE_USER
ARG DATABASE_PASS
ARG DATABASE

ARG SET_STORE_NOTIFICATION_FLAG
ARG SENDGRID_NOTIFICATION_BEHAVIOR
ARG SEND_ERROR_EMAILS
ARG SEND_ITEM_STATUS_UPDATE_EMAILS

ARG FB_VERIFY_TOKEN
ARG FB_ACCESS_TOKEN

ARG CRON_INTERVAL_STORE_NOTIFICATIONS
ARG CRON_INTERVAL_CURRENCY
ARG CRON_INTERVAL_BANK_TRANSFERS

ARG DUET_BENEFICIARIES_URL

ARG BENEFICIARY_MATCHING_TOTAL_EUR_DONATED_WEIGHT
ARG BENEFICIARY_MATCHING_RECENT_EUR_DONATED_WEIGHT
ARG BENEFICIARY_MATCHING_BASELINE_SCORE

ENV SENDGRID_API_KEY=$SENDGRID_API_KEY
    
ENV AWS_S3_BUCKET_NAME=$AWS_S3_BUCKET_NAME
ENV AWS_S3_IMAGE_FOLDER=$AWS_S3_IMAGE_FOLDER
ENV AWS_ACCESS_KEY_S3=$AWS_ACCESS_KEY_S3
ENV AWS_SECRET_ACCESS_KEY_S3=$AWS_SECRET_ACCESS_KEY_S3

ENV PAYPAL_LOW_BALANCE_THRESHOLD=$PAYPAL_LOW_BALANCE_THRESHOLD
ENV PAYPAL_MODE=$PAYPAL_MODE
ENV PAYPAL_CLIENT_ID=$PAYPAL_CLIENT_ID
ENV PAYPAL_CLIENT_SECRET=$PAYPAL_CLIENT_SECRET
ENV PAYPAL_NVP_API_USERNAME=$PAYPAL_NVP_API_USERNAME
ENV PAYPAL_NVP_API_PASSWORD=$PAYPAL_NVP_API_PASSWORD
ENV PAYPAL_NVP_API_SIGNATURE=$PAYPAL_NVP_API_SIGNATURE

ENV TRANSFERWISE_API=$TRANSFERWISE_API
ENV TRANSFERWISE_API_KEY=$TRANSFERWISE_API_KEY
ENV TRANSFERWISE_LOW_BALANCE_THRESHOLD=$TRANSFERWISE_LOW_BALANCE_THRESHOLD

ENV DATABASE_HOST=$DATABASE_HOST
ENV DATABASE_PORT=$DATABASE_PORT
ENV DATABASE_USER=$DATABASE_USER
ENV DATABASE_PASS=$DATABASE_PASS
ENV DATABASE=$DATABASE

ENV SET_STORE_NOTIFICATION_FLAG=$SET_STORE_NOTIFICATION_FLAG
ENV SENDGRID_NOTIFICATION_BEHAVIOR=$SENDGRID_NOTIFICATION_BEHAVIOR
ENV SEND_ERROR_EMAILS=$SEND_ERROR_EMAILS
ENV SEND_ITEM_STATUS_UPDATE_EMAILS=$SEND_ITEM_STATUS_UPDATE_EMAILS

ENV FB_VERIFY_TOKEN=$FB_VERIFY_TOKEN
ENV FB_ACCESS_TOKEN=$FB_ACCESS_TOKEN

ENV CRON_INTERVAL_STORE_NOTIFICATIONS=$CRON_INTERVAL_STORE_NOTIFICATIONS
ENV CRON_INTERVAL_CURRENCY=$CRON_INTERVAL_CURRENCY
ENV CRON_INTERVAL_BANK_TRANSFERS=$CRON_INTERVAL_BANK_TRANSFERS

ENV DUET_BENEFICIARIES_URL=$DUET_BENEFICIARIES_URL

ENV BENEFICIARY_MATCHING_TOTAL_EUR_DONATED_WEIGHT=$BENEFICIARY_MATCHING_TOTAL_EUR_DONATED_WEIGHT
ENV BENEFICIARY_MATCHING_RECENT_EUR_DONATED_WEIGHT=$BENEFICIARY_MATCHING_RECENT_EUR_DONATED_WEIGHT
ENV BENEFICIARY_MATCHING_BASELINE_SCORE=$BENEFICIARY_MATCHING_BASELINE_SCORE

RUN npm run build

CMD [ "npm", "start" ]
